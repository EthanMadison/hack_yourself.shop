{% extends "base.html" %}
{% block content %}
<h1>Каталог</h1>
<div class="grid">
  {% for p in products %}
  <div class="product-card centered">
    <a href="{{ url_for('shop.product_detail', pid=p.id) }}">
      <img src="{{ url_for('static', filename=p.image or 'img/placeholder.jpg') }}" alt="{{ p.name }}">
      <h3>{{ p.name }}</h3>
    </a>
    <p class="muted">{{ p.category.name if p.category else 'Без категории' }}</p>
    <p class="price">{{ '%.2f'|format(p.price) }} ₽</p>
    {% set qty_in_cart = (session.get('cart') or {}).get(p.id|string) %}
    {% if qty_in_cart %}
      <button type="button" disabled class="in-cart" data-pid="{{ p.id }}">В корзине ({{ qty_in_cart }})</button>
    {% else %}
      <button type="button" class="add-to-cart" data-pid="{{ p.id }}">В корзину</button>
    {% endif %}
  </div>
  {% endfor %}
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  function updateCartLink(size) {
    const c = document.getElementById('cart-counter'); if (c) c.textContent = size;
  }
  async function addToCart(pid, qty, btn) {
    try {
      const resp = await fetch(`/cart/add/${pid}`, {
        method: 'POST',
        headers: {'X-Requested-With': 'XMLHttpRequest', 'Content-Type': 'application/x-www-form-urlencoded'},
        body: new URLSearchParams({ qty: String(qty || 1) })
      });
      if (!resp.ok) throw new Error('Network error');
      const data = await resp.json();
      if (data.ok) {
        const nb = document.createElement('button'); nb.className='in-cart'; nb.disabled=true;
        nb.textContent = `В корзине (${data.qty})`; btn.replaceWith(nb); updateCartLink(data.cart_size);
      }
    } catch(e){ console.error(e); }
  }
  document.querySelectorAll('.add-to-cart').forEach(btn => {
    btn.addEventListener('click', () => addToCart(btn.dataset.pid, 1, btn));
  });
});
</script>
{% endblock %}